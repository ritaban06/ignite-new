name: Build & Release Debug APK using Capacitor

on:
  workflow_dispatch:

jobs:
  build-debug:
    name: Build Debug APK
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üü¢ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: üì• Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: client

      - name: üõ† Build React app
        run: pnpm run build
        working-directory: client
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_GOOGLE_ANDROID_CLIENT_ID_DEBUG: ${{ secrets.VITE_GOOGLE_ANDROID_CLIENT_ID_DEBUG }}
          NODE_ENV: production
          VITE_SOCIAL_LOGIN_PROVIDER: google

      - name: üèó Build and Release Debug APK with Capacitor Action
        uses: Narottam04/action-capacitor-android@v2 # Use the marketplace action
        with:
          # Your app's directory. This is optional if your app is at the root.
          android-subfolder: 'client/android'
          # Your web app's build output directory. In your case, it is client/dist
          build-folder: 'client/dist'
          # You want a debug build.
          type: debug
          # Define the path where the apk should be uploaded
          path-to-apk: 'client/android/app/build/outputs/apk/debug/'
          # Additional gradle arguments. You can pass the Java version here.
          gradle-args: '-Dorg.gradle.java.home=/usr/lib/jvm/java-17-temurin'
        env:
          # The action will automatically use the build output, but your web build still needs env vars.
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SOCIAL_LOGIN_PROVIDER: google
          VITE_GOOGLE_ANDROID_CLIENT_ID_DEBUG: ${{ secrets.VITE_GOOGLE_ANDROID_CLIENT_ID_DEBUG }}

      - name: üöÄ Upload Debug APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: v1.0.${{ github.run_number }}
          files: |
            client/android/app/build/outputs/apk/debug/*.apk
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
